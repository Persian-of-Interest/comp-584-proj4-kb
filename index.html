<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Star Wars Search</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="https://unpkg.com/popmotion/dist/popmotion.global.min.js"></script>
</head>
<body>
  <canvas id="stars"></canvas>

  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Categories">
      <h4>Categories</h4>
      <div class="cat-list" id="categoryList">
        <!-- category items injected here -->
      </div>
      <div style="margin-top:auto;text-align:center;color:var(--muted);font-size:12px;padding:6px">Click a category to browse all items</div>
    </aside>


<!-- Main search/results panel -->
<main class="panel" role="main">
  <h2>Star Wars Search</h2>
  <p class="small">Type a name (e.g., "Luke Skywalker", "Tatooine", "Falcon"). The app will auto-search across common resources (people, planets, starships, vehicles, species, films) and return matches. You may also prefix the query with a resource, e.g. <code>people: luke</code>.</p>

  <div style="margin-top:12px" class="search-row">
    <input id="searchInput" class="form-control" placeholder="Search by name — try: Luke Skywalker" />
    <button id="searchBtn" class="btn btn-primary">Search</button>
    <button id="clearBtn" class="btn btn-outline-light">Clear</button>
  </div>

  <div id="results" style="margin-top:14px">Start a search to see results.</div>
</main>


  </div>

  <script>
    const resources = [ 'people', 'planets', 'starships', 'vehicles', 'species', 'films' ];
    const resultsBox = document.getElementById('results');
    const searchBtn = document.getElementById('searchBtn');
    const clearBtn = document.getElementById('clearBtn');
    const searchInput = document.getElementById('searchInput');
    const categoryList = document.getElementById('categoryList');
    const { styler, spring } = window.popmotion || {};

    function setLoading(is) {
      // Remove any existing overlay first
      const existingOverlay = document.querySelector('.global-loader-overlay');
      if (existingOverlay) {
        existingOverlay.remove();
      }

      if (!is) return; // exit early if turning off loader

      // Create full-screen overlay
      const overlay = document.createElement('div');
      overlay.className = 'global-loader-overlay';
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.background = 'rgba(0,0,0,0.35)';
      overlay.style.backdropFilter = 'blur(2px)';
      overlay.style.display = 'flex';
      overlay.style.flexDirection = 'column';
      overlay.style.justifyContent = 'center';
      overlay.style.alignItems = 'center';
      overlay.style.zIndex = '9999';
      document.body.appendChild(overlay);

      // Loader container
      const loaderContainer = document.createElement('div');
      loaderContainer.style.display = 'flex';
      loaderContainer.style.flexDirection = 'column';
      loaderContainer.style.alignItems = 'center';
      loaderContainer.style.justifyContent = 'center';
      overlay.appendChild(loaderContainer);

      // GIF
      const gif = document.createElement('img');
      gif.src = 'assets/loading.gif';
      gif.alt = 'Loading...';
      gif.style.width = '260px';
      gif.style.height = '260px';
      gif.style.objectFit = 'contain';
      loaderContainer.appendChild(gif);

      // Loading text
      const loadingText = document.createElement('div');
      loadingText.textContent = 'Loading…';
      loadingText.style.marginTop = '10px';
      loadingText.style.fontFamily = 'Arial, sans-serif';
      loadingText.style.fontSize = '16px';
      loadingText.style.color = '#FF964B';
      loadingText.style.fontWeight = 'bold';
      loaderContainer.appendChild(loadingText);
    }

    function makeCard(item, resource){
      const uid = item.uid || (item.url && item.url.split('/').filter(Boolean).pop());
      const name = item.name || (item.properties && (item.properties.name || item.properties.title)) || uid;
      const div = document.createElement('div');
      div.className = 'result-card lightsaber-hover';
      div.dataset.resource = resource;
      div.dataset.uid = uid;

      const thumb = document.createElement('div');
      thumb.className = 'thumb';
      const img = document.createElement('img');
      img.className = 'img-cover';
      img.style.width = '100%';
      img.style.height = '100%';
      img.alt = name;

      const folder = resource === 'people' ? 'characters' :
                     resource === 'planets' ? 'planets' :
                     resource === 'starships' ? 'starships' :
                     resource === 'vehicles' ? 'vehicles' :
                     resource === 'species' ? 'species' :
                     resource === 'films' ? 'films' : '';

      if(folder && uid){
        if(resource === 'people'){ img.src = `assets/img/people/${uid}.jpg`; }
        if(resource === 'planets'){ img.src = `assets/img/planets/${uid}.jpg`; }
        if(resource === 'starships'){ img.src = `assets/img/starships/${uid}.jpg`; }
        if(resource === 'vehicles'){ img.src = `assets/img/vehicles/${uid}.jpg`; }
        if(resource === 'species'){ img.src = `assets/img/species/${uid}.jpg`; }
        if(resource === 'films'){ img.src = `assets/img/films/${uid}.jpg`; }
        img.onerror = () => { thumb.textContent = resource; thumb.style.fontSize = '12px'; thumb.style.color = 'var(--muted)'; };
        thumb.appendChild(img);
      } else { thumb.textContent = resource; }

      const det = document.createElement('div');
      det.className = 'details';
      det.innerHTML = `<div style="font-weight:600">${name}</div><div class="meta">${resource} • uid: ${uid || '—'}</div>`;
      div.appendChild(thumb); div.appendChild(det);

      if(styler && spring){
        const s = styler(div);
        s.set({y:20, opacity:0});
        spring({from:{y:20, opacity:0}, to:{y:0, opacity:1}, stiffness:120, damping:12}).start(v=>s.set(v));
      }

      div.addEventListener('click', ()=> showDetails(resource, uid));

      return div;
    }

    // === Search uses swapi.tech (keeps original smartSearch behaviour) ===
    async function smartSearch(query){
      query=query.trim(); if(!query) return;
      const prefixMatch=query.match(/^([a-zA-Z]+)\s*:\s*(.+)$/);
      let resourceList=resources; let name=query;
      if(prefixMatch && resources.includes(prefixMatch[1].toLowerCase())){ 
        resourceList=[prefixMatch[1].toLowerCase()]; 
        name=prefixMatch[2]; 
      }

      setLoading(true);
      try{
        for(const r of resourceList){
          try{
            const url = `https://www.swapi.tech/api/${r}/?name=${encodeURIComponent(name)}`;
            const res = await fetch(url);
            const json = await res.json();
            if(json?.result?.length){
              resultsBox.innerHTML='';
              json.result.forEach(item=>resultsBox.appendChild(makeCard({uid:item.uid,name:item.name,properties:item.properties},r)));
              return;
            }
          } catch(e){ console.warn('search error', e); }
        }
        resultsBox.innerHTML='<div class="small">No matches found across resources.</div>';
      } finally {
        // Hide loader after async work is done
        setLoading(false);
      }
    }

    // === Details view (swapi.tech) ===
    async function showDetails(resource, uid){
      setLoading(true); 
      if(!uid){ 
        resultsBox.innerHTML = '<div class="small">No UID available for this item.</div>'; 
        return; 
      }
      try{
        const res = await fetch(`https://www.swapi.tech/api/${resource}/${uid}`);
        const json = await res.json();
        if(!json?.result?.properties){ resultsBox.innerHTML = '<div class="small">Details not found.</div>'; return; }
        const p = json.result.properties;

        async function fetchNames(urls){ if(!urls||urls.length===0) return []; return await Promise.all(urls.map(async u=>{ try{ const r=await fetch(u); const j=await r.json(); return j.result?.properties?.name||j.result?.properties?.title||'—'; } catch(e){ return '—'; } })); }

        const container = document.createElement('div');
        const relatedFields = ['starships','vehicles','planets','characters','people','species','pilots','films'];
        const relatedHtml = await Promise.all(relatedFields.map(async field=>{ if(p[field]?.length){ const names = await fetchNames(p[field]); return `<div><strong>${field.replace(/_/g,' ')}:</strong> ${names.join(', ')}</div>`; } else return ''; }));

        let homeworldHtml = '';
        if(p.homeworld){ const name = await fetchNames([p.homeworld]); homeworldHtml = `<div><strong>homeworld:</strong> ${name[0]}</div>`; }

        let imgSrc = '';
        if(resource==='people'){ imgSrc=`./assets/img/people/${uid}.jpg`; }
        else if(resource==='planets'){ imgSrc=`./assets/img/planets/${uid}.jpg`; }
        else if(resource==='starships'){ imgSrc=`./assets/img/starships/${uid}.jpg`; }
        else if(resource==='vehicles'){ imgSrc=`./assets/img/vehicles/${uid}.jpg`; }
        else if(resource==='species'){ imgSrc=`./assets/img/species/${uid}.jpg`; }
        else if(resource==='films'){ imgSrc=`./assets/img/films/${uid}.jpg`; }
        else{ const folder = resource==='people' ? 'characters' : resource==='planets' ? 'planets' : resource==='starships' ? 'starships' : resource==='vehicles' ? 'vehicles' : resource==='species' ? 'species' : ''; imgSrc=folder?`./assets/img/${folder}/${uid}.jpg`:''; }

        container.innerHTML = `<div style="display:grid;grid-template-columns:120px 1fr;gap:12px;align-items:start">
            <div>${imgSrc?`<img src="${imgSrc}" onerror="this.style.display='none'" style="width:100%;border-radius:8px"/>`:''}</div>
            <div><h4 style="margin:0">${p.name||p.title||'—'}</h4>
              <div class="small" style="margin-top:6px">Resource: ${resource} • uid: ${uid}</div>
            <div style="margin-top:10px">${Object.entries(p).filter(([k,_])=>!['created','edited','url','homeworld'].includes(k) && !relatedFields.includes(k)).map(([k,v])=>`<div><strong>${k.replace(/_/g,' ')}:</strong> ${v}</div>`).join('')}${homeworldHtml}${relatedHtml.join('')}</div></div></div>`;
        resultsBox.innerHTML=''; resultsBox.appendChild(container);
      } catch(err) { 
        console.error(err); 
        resultsBox.innerHTML='<div class="small">Error loading details.</div>'; 
      } finally {
        // Hide loader after async work is done
        setLoading(false);
      }
    }

    // ====================== CATEGORIES USING OLD SWAPI.DEV (fetch all pages) ======================
    async function fetchAllFromSwapiDev(resource){
      const accumulated = [];
      let url = `https://swapi.dev/api/${resource}/`;
      try{
        while(url){
          const res = await fetch(url);
          if(!res.ok) throw new Error('network error');
          const json = await res.json();
          if(json.results && json.results.length) accumulated.push(...json.results);
          url = json.next; // swapi.dev uses full next URL or null
        }
      } catch(e) {
        console.error('fetchAllFromSwapiDev error for', resource, e);
        throw e;
      }
      return accumulated;
    }

    async function fetchCategory(resource){
      setLoading(true); 
      try{
        const items = await fetchAllFromSwapiDev(resource);
        resultsBox.innerHTML = '';
        if(items && items.length){
          // items from swapi.dev don't have uid directly; derive from url
          items.forEach(item => {
            const uid = (item.url || '').split('/').filter(Boolean).pop();
            resultsBox.appendChild(makeCard({ uid, name: item.name || item.title, properties: item }, resource));
          });
        } else {
          resultsBox.innerHTML = '<div class="small">No items found in this category.</div>';
        }
      } catch(e) {
        resultsBox.innerHTML = '<div class="small">Error fetching category.</div>';
        console.error(e);
      } finally {
        // Hide loader after async work is done
        setLoading(false);
      }
    }

    // Populate the left sidebar
    function renderSidebar(){
      categoryList.innerHTML = '';
      resources.forEach(r => {
        const el = document.createElement('div');
        el.className = 'cat-item';
        el.dataset.resource = r;

        const thumb = document.createElement('div');
        thumb.className = 'cat-thumb';
        // try to show an image if present in assets; fall back to resource text
        const img = new Image();
        img.src = `assets/img/hero/${r}.jpg`;
        img.onload = () => { thumb.style.backgroundImage = `url('${img.src}')`; thumb.style.backgroundSize = 'cover'; thumb.textContent = ''; };
        img.onerror = () => { thumb.textContent = r.charAt(0).toUpperCase(); };

        const label = document.createElement('div');
        label.className = 'cat-label';
        label.textContent = r.charAt(0).toUpperCase() + r.slice(1);

        el.appendChild(thumb);
        el.appendChild(label);

        // popmotion hover (subtle lift) and click
        if(styler && spring){
          const s = styler(el);
          el.addEventListener('mouseenter', ()=> spring({ from:{ y:0 }, to:{ y:-4 }, stiffness:220, damping:14 }).start(v => s.set(v)));
          el.addEventListener('mouseleave', ()=> spring({ from:{ y:-4 }, to:{ y:0 }, stiffness:220, damping:14 }).start(v => s.set(v)));
        }

        el.addEventListener('click', () => {
          // when a category is clicked, fetch from swapi.dev (categories)
          fetchCategory(r);
        });

        categoryList.appendChild(el);
      });
    }

    // wire up search + clear
    searchBtn.addEventListener('click', ()=> { if(searchInput.value.trim()) smartSearch(searchInput.value); });
    clearBtn.addEventListener('click', ()=> { resultsBox.innerHTML='Start a search to see results.'; searchInput.value=''; });
    searchInput.addEventListener('keydown', e => { if(e.key==='Enter') searchInput.value && smartSearch(searchInput.value); });

    // initial render of sidebar
    renderSidebar();

    // Hyperspace starfield animation
    const canvas = document.getElementById('stars');
    const ctx = canvas.getContext('2d');
    const STAR_COUNT = 200;
    let stars = [];

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    for (let i = 0; i < STAR_COUNT; i++) {
      stars.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        z: Math.random() * 2 + 0.5,
        vx: (Math.random() - 0.5) * 0.2,
        vy: (Math.random() - 0.5) * 0.2
      });
    }

    function animateStars() {
      ctx.fillStyle = '#071021';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      const cx = canvas.width / 2;
      const cy = canvas.height / 2;

      for (let s of stars) {
        s.z -= 0.05; // move star toward viewer
        if (s.z <= 0) {
          s.z = Math.random() * 2 + 0.5;
          s.x = (Math.random() - 0.5) * canvas.width;
          s.y = (Math.random() - 0.5) * canvas.height;
        }

        const px = cx + s.x / s.z;
        const py = cy + s.y / s.z;
        const radius = (2 / s.z);

        ctx.beginPath();
        ctx.arc(px, py, radius, 0, Math.PI * 2);
        ctx.fillStyle = 'white';
        ctx.fill();
      }
      requestAnimationFrame(animateStars);
    }
    animateStars();

  </script>

</body>
</html>
