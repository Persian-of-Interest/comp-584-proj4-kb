<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Star Wars Search • SWAPI.tech + Popmotion</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/popmotion/dist/popmotion.global.min.js"></script>
  <style>
    :root{ --bg:#071021; --card:#0f1724; --muted:#97a6b2; --accent:#f59e0b }
    body{ background: linear-gradient(180deg,var(--bg), #051021); color:#e6eef6; font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; padding:28px }
    .app{ max-width:1100px; margin:0 auto; display:grid; grid-template-columns: 1fr 420px; gap:24px }
    .panel{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:18px; box-shadow:0 12px 40px rgba(2,6,23,.6); border:1px solid rgba(255,255,255,0.03) }
    .search-row{ display:flex; gap:8px }
    #results{ min-height:300px }
    .result-card{ background:linear-gradient(180deg,#071026,#061423); border-radius:10px; padding:12px; display:flex; gap:12px; align-items:center; margin-bottom:10px; cursor:pointer; border:1px solid rgba(255,255,255,0.02) }
    .result-card:hover{ transform:translateY(-4px); transition:transform .18s ease }
    .thumb{ width:86px; height:86px; border-radius:8px; background:linear-gradient(180deg,#052033,#031827); display:flex; align-items:center; justify-content:center; color:var(--muted); font-size:12px; overflow:hidden }
    .details{ flex:1 }
    .meta{ color:var(--muted); font-size:13px }
    .loader{ width:40px; height:40px; border-radius:50%; border:4px solid rgba(255,255,255,0.06); border-top-color:var(--accent); animation:spin 1s linear infinite; margin:auto }
    @keyframes spin{ to{ transform:rotate(360deg) } }
    .side{ display:flex; flex-direction:column; gap:12px }
    #card{ height:260px; border-radius:12px; display:flex; align-items:center; justify-content:center; user-select:none; cursor:grab }
    .small{ font-size:13px; color:var(--muted) }
    .detail-panel{ margin-top:8px; background:rgba(255,255,255,0.02); padding:10px; border-radius:8px }
    .img-cover{ width:100%; height:200px; object-fit:cover; border-radius:8px; background:#061428 }
    @media(max-width:980px){ .app{ grid-template-columns:1fr; } .side{ order:-1 } }
  </style>
</head>
<body>
  <div class="app">
    <div class="panel">
      <h2>Star Wars Search</h2>
      <p class="small">Type a name (e.g., "Luke Skywalker", "Tatooine", "Falcon"). The app will auto-search across common resources (people, planets, starships, vehicles, species, films) and return matches. You may also prefix the query with a resource, e.g. <code>people: luke</code>.</p>


  <div style="margin-top:12px" class="search-row">
    <input id="searchInput" class="form-control" placeholder="Search by name — try: Luke Skywalker" />
    <button id="searchBtn" class="btn btn-primary">Search</button>
    <button id="clearBtn" class="btn btn-outline-light">Clear</button>
  </div>

  <div id="results" style="margin-top:14px">Start a search to see results.</div>
</div>

<div class="panel side">
  <h4>Popmotion Playground</h4>
  <div id="card" class="panel" style="background:linear-gradient(180deg,#07183b,#05203b)">Drag / Throw Me</div>
  <div class="detail-panel">
    <div class="small">Click a result to see details. Images are attempted from <code>starwars-visualguide.com</code> and may 404 for some entries — the UI falls back to a textual thumb.</div>
  </div>
</div>


  </div>

  <script>
    // Resources to attempt searching in order
    const resources = [ 'people', 'planets', 'starships', 'vehicles', 'species', 'films' ];
    const resultsBox = document.getElementById('results');
    const searchBtn = document.getElementById('searchBtn');
    const clearBtn = document.getElementById('clearBtn');
    const searchInput = document.getElementById('searchInput');

    // Popmotion utilities (older global bundle)
    const { styler, spring, pointer, listen, value, tween } = window.popmotion || {};

    function setLoading(is){
      resultsBox.innerHTML = is ? '<div style="display:flex;align-items:center;justify-content:center;height:160px"><div class="loader"></div></div>' : '';
    }

    // Create a result card element
    function makeCard(item, resource){
      const uid = item.uid || (item.url && item.url.split('/').filter(Boolean).pop());
      const name = item.name || (item.properties && (item.properties.name || item.properties.title)) || uid;

      const div = document.createElement('div');
      div.className = 'result-card';
      div.dataset.resource = resource;
      div.dataset.uid = uid;

      const thumb = document.createElement('div');
      thumb.className = 'thumb';

      const img = document.createElement('img');
      img.className = 'img-cover';
      img.style.width = '100%';
      img.style.height = '100%';
      img.alt = name;

      // Map resource to visualguide folder
      const folder = resource === 'people' ? 'characters' :
                     resource === 'planets' ? 'planets' :
                     resource === 'starships' ? 'starships' :
                     resource === 'vehicles' ? 'vehicles' :
                     resource === 'species' ? 'species' : '';

      // Use local images for people only
      if(folder && uid){
        if(resource === 'people'){
          img.src = `assets/img/people/${uid}.jpg`;  // <-- local folder for people
        } else {
          img.src = `https://starwars-visualguide.com/assets/img/${folder}/${uid}.jpg`;
        }
        img.onerror = () => {
          // fallback: show text label when no image
          thumb.textContent = resource;
          thumb.style.fontSize = '12px';
          thumb.style.color = 'var(--muted)';
        };
        thumb.appendChild(img);
      } else {
        thumb.textContent = resource;
      }

      const det = document.createElement('div');
      det.className = 'details';
      det.innerHTML = `<div style="font-weight:600">${name}</div><div class="meta">${resource} • uid: ${uid || '—'}</div>`;

      div.appendChild(thumb);
      div.appendChild(det);

      div.addEventListener('click', ()=> showDetails(resource, uid, div) );

      return div;
    }

    // Show full details for a resource item
    async function showDetails(resource, uid, anchor){
      try {
        if(styler && tween){
          const s = styler(anchor);
          tween({ from:{ scale:1 }, to:{ scale:1.03 }, duration:120 }).start(v => s.set('scale', v.scale));
          setTimeout(()=>tween({ from:{ scale:1.03 }, to:{ scale:1 }, duration:140 }).start(v => s.set('scale', v.scale)), 120);
        }
      } catch(e){}

      resultsBox.innerHTML = '<div style="text-align:center;padding:30px"><div class="loader"></div><div class="small" style="margin-top:8px">Loading details...</div></div>';

      try{
        if(!uid){
          resultsBox.innerHTML = '<div class="small">No UID available for this item.</div>';
          return;
        }
        const res = await fetch(`https://www.swapi.tech/api/${resource}/${uid}`);
        const json = await res.json();
        if(!json || !json.result || !json.result.properties){
          resultsBox.innerHTML = '<div class="small">Details not found.</div>';
          return;
        }
        const p = json.result.properties;

        // Helper: fetch names from URL array
        async function fetchNames(urls){
          if(!urls || urls.length===0) return [];
          const names = await Promise.all(urls.map(async u => {
            try {
              const r = await fetch(u);
              const j = await r.json();
              return j.result?.properties?.name || j.result?.properties?.title || '—';
            } catch(e){ return '—'; }
          }));
          return names;
        }

        const container = document.createElement('div');

        // Build list of related resource names
        const relatedFields = ['starships','vehicles','planets','characters','people','species','films'];
        const relatedHtml = await Promise.all(relatedFields.map(async field => {
          if(p[field] && Array.isArray(p[field]) && p[field].length){
            const names = await fetchNames(p[field]);
            return `<div><strong>${field.replace(/_/g,' ')}:</strong> ${names.join(', ')}</div>`;
          } else return '';
        }));

        // Handle single URL fields like homeworld
        let homeworldHtml = '';
        if(p.homeworld){
          const name = await fetchNames([p.homeworld]);
          homeworldHtml = `<div><strong>homeworld:</strong> ${name[0]}</div>`;
        }

        // Determine folder for detail image
        let imgSrc = '';
        if(resource === 'people'){
            imgSrc = `./assets/img/people/${uid}.jpg`; // local image
        } else {
            const folder = resource==='people' ? 'characters' :
                          resource==='planets' ? 'planets' :
                          resource==='starships' ? 'starships' :
                          resource==='vehicles' ? 'vehicles' :
                          resource==='species' ? 'species' : '';
            imgSrc = folder ? `https://starwars-visualguide.com/assets/img/${folder}/${uid}.jpg` : '';
        }

        container.innerHTML = `
          <div style="display:grid;grid-template-columns:120px 1fr;gap:12px;align-items:start">
            <div>
              ${imgSrc ? `<img src="${imgSrc}" onerror="this.style.display='none'" style="width:100%;border-radius:8px" />` : ''}
            </div>
            <div>
              <h4 style="margin:0">${p.name || p.title || '—'}</h4>
              <div class="small" style="margin-top:6px">Resource: ${resource} • uid: ${uid}</div>
              <div style="margin-top:10px">
                ${Object.entries(p)
                  .filter(([k,_])=>!['created','edited','url','homeworld'].includes(k) && !relatedFields.includes(k))
                  .map(([k,v])=>`<div><strong>${k.replace(/_/g,' ')}:</strong> ${v}</div>`).join('')}
                ${homeworldHtml}
                ${relatedHtml.join('')}
              </div>
            </div>
          </div>
        `;
        resultsBox.innerHTML = '';
        resultsBox.appendChild(container);
      }catch(err){
        console.error(err);
        resultsBox.innerHTML = '<div class="small">Error loading details.</div>';
      }
    }

    // Smart search across resources. If user supplies prefix like 'people: luke', use only that resource.
    async function smartSearch(query){
      query = query.trim();
      if(!query) return;

      const prefixMatch = query.match(/^([a-zA-Z]+)\s*:\s*(.+)$/);
      let resourceList = resources;
      let name = query;
      if(prefixMatch && resources.includes(prefixMatch[1].toLowerCase())){
        resourceList = [ prefixMatch[1].toLowerCase() ];
        name = prefixMatch[2];
      }

      setLoading(true);

      for(const r of resourceList){
        try{
          // SWAPI.tech supports ?name= search for many resources
          const url = `https://www.swapi.tech/api/${r}/?name=${encodeURIComponent(name)}`;
          const res = await fetch(url);
          const json = await res.json();

          if(json && json.result && Array.isArray(json.result) && json.result.length){
            resultsBox.innerHTML = '';
            json.result.forEach(item => {
              const card = makeCard({ uid: item.uid, name: item.name, properties: item.properties }, r);
              resultsBox.appendChild(card);
            });
            return;
          }

        }catch(e){
          console.warn('search error', e);
          // continue to next resource
        }
      }

      resultsBox.innerHTML = '<div class="small">No matches found across resources.</div>';
    }

    // Bind UI
    searchBtn.addEventListener('click', ()=>{ const q = searchInput.value; if(!q.trim()) return; smartSearch(q); });
    clearBtn.addEventListener('click', ()=>{ resultsBox.innerHTML = 'Start a search to see results.'; searchInput.value=''; });
    searchInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') searchBtn.click(); });

    // Popmotion draggable card in the side panel
    const demoCard = document.getElementById('card');
    try {
      if(pointer && spring && listen && value && styler){
        const cardStyler = styler(demoCard);
        const cardPos = value({ x:0, y:0 }, v => cardStyler.set(v));

        listen(demoCard, 'pointerdown').start((e)=>{
          e.preventDefault();
          const start = { x: e.clientX, y: e.clientY };
          const origin = cardPos.get();
          const move = pointer({ x: start.x, y: start.y });
          const moveSub = move.start(({ x, y })=>{
            cardPos.update({ x: origin.x + (x - start.x), y: origin.y + (y - start.y) });
          });

          const up = listen(window, 'pointerup').start(()=>{
            moveSub.stop(); up.stop();
            spring({ from: cardPos.get(), to: { x:0, y:0 }, stiffness: 180, damping: 14 }).start(v => cardPos.update(v));
          });
        });
      }
    } catch(e){ /* ignore popmotion errors */ }
  </script>

</body>
</html>
